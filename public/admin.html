<!DOCTYPE html>
<html>
  <head>
    <title>Fleuréa Dispatcher | Portail administration</title>
    <link rel="shortcut icon" href="https://res.cloudinary.com/devee5rfe/image/upload/v1754320567/OIP_lz4npc.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  </head>
  <body>
    <div id="toast-container"></div>
    <div id="lightbox">
      <div class="lightbox-content w3-center">
        <span id="close-btn">&times;</span>
        <div class="circleB" style="top:50%; left:50%; transform:translate(-50%,-50%)">
          <img id="lightImg" onclick="window.location.assign(`/icon?type=comptes&id=${sessionStorage.getItem('session_id')}`, '_blank');" src="" alt="Profil">
        </div>
        <h2 id="lightH2"></h2>
        <p id="lightP"></p>
        <button onclick="fetcher('logout',{'session_id':sessionStorage.getItem('session_id'), 'token':localStorage.getItem('offtoken')},'POST',sessionStorage.getItem('session_id'));">Se déconnecter</button>
      </div>
    </div>
     <div id="lightboxB">
      <div class="lightbox-content w3-center">
        <span id="close-btnB">&times;</span>
        <div class="circleB" style="top:50%; left:50%; transform:translate(-50%,-50%)">
          <img id="imagePop" src="" alt="Profil">
        </div>
        <p id="lightPB3"></p>
        <h2 id="lightH2B"></h2>
        <p id="lightPB"></p>
        <i id="lightPB2"></i>
        <br><br>
        <div style="display:none;" id="editeurLightBenne">
          <div class="w3-center">
          <i>Sélectionnez un paramètre puis modifiez-le...</i>
            <select id="modifierSelecter"></select>
            <input id="inpSelecter" type="text" name="valueSelecter">
            <div id="suggester"></div>
            <button id="registerPop" onclick="logModification()">Enregistrer</button>
          </div>
        </div>
        <button onclick="if (document.getElementById('editeurLightBenne').style.display == 'none') {document.getElementById('editeurLightBenne').style.display = 'flex'} else {document.getElementById('editeurLightBenne').style.display = 'none'}">Éditer</button>
        <button id="deleter" onclick="deleteBenne(numon)">Supprimer</button>
      </div>
    </div>
   <div class="head" id="head">
     <div id="heure"><p id="time">N/A</p></div>
     <div id="portal"><p>Portail Administration</p></div>
       <button onclick="document.getElementById('map').style.display='flex';document.getElementById('admin').style.display='none'; resizeMap();" id="visuBtn">Voir la carte</button>
       <button onclick="document.getElementById('map').style.display='none';document.getElementById('admin').style.display='flex';" id="adminBtn">Administration</button>
     <div id="logo_eurea">
       <img src="https://res.cloudinary.com/devee5rfe/image/upload/v1754320567/OIP_lz4npc.jpg" onclick="window.location.href = 'https://www.groupe-eurea.com/';" alt="Logo Euréa">
       </div>
   <div id="compte">
      <div class="circle"> 
      <img id="myPict" src="" alt="Icône du propriétaire du compte">
      </div>
     <p id="myName">ADMIN</p>
   </div>
   </div>

    <div id="map">
      
      <div id="legende" style="flex-direction:column; justify-content:space-around;">
      <div style="display:flex; align-items:center; justify-content:space-around; flex-direction:row;">
        <span class="dot" style=" background-color: yellow;"></span>
        <i>Posée</i>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-around; flex-direction:row;">
        <span class="dot" style=" background-color: red;"></span>
        <i>Prête</i>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-around; flex-direction:row;">
        <span class="dot" style=" background-color: blue;"></span>
        <i>Dépôt</i>
      </div>
    </div>
      
      <div id="panel">
        <button onclick="document.getElementById('panel').style.display='none';  document.getElementById('mapSearch').style.display = 'flex'; onshow=false;">Fermer le panneau latéral</button>
        <div class="w3-center" id="panelcontent">
          <div id="panel_A">
            <img class="cropped-image" id="panel_A_img" src="https://cdn.pixabay.com/photo/2025/05/15/18/28/field-9602521_1280.jpg" alt="photobenne">
            <h1 id="panel_A_h1">521</h1>
          </div>
           <div class="w3-center" id="panel_B">
            <p id="panel_B_p">En dépôt</p>
          </div>
                       <div id="panel_editer">
                        <button id="editer_a"></button>
                        <button id="editer_b"></button>
                        <button id="editer_c"></button>
                      </div>
          <div class="w3-center" id="panel_C">
            <strong><p id="panel_C_p">Ferme des Monts</p></strong>
            <i id="panel_C_i">07 55 99 44 76</i>
          </div>

                      <div id="farm_input">
                        <input id="farm_input_search" type="text" placeholder="Entrez un id, nom ou adresse de ferme...">
                      </div>
          
          <div class="w3-center" id="panel_V">
            <p id="panel_V_p">Aucun signalement de la benne</p>
            <p id="panel_V_pb">Aucun signalement de la ferme</p>
          </div>
           <div class="w3-center" id="panel_D">
            <a id="panel_D_i" href="maps.google.com" target="_blank">29, chemin du lavoir, Périgneux</a>
          </div>
           <div id="panel_E">
             <div id="panel_E_circle" class="circleC">
            <img id="panel_E_img" src="https://cdn.pixabay.com/photo/2016/07/26/15/33/soybeans-1543071_1280.jpg" alt="photocereale">
             </div>
            <h1 id="panel_E_h1">Blé</h1>
          </div>

                    <div id="cereale_input">
                        <input id="cereale_input_search" type="text" placeholder="Entrez un code ou nom de céréale...">
                            <div id="bio_block" style="align-items:center; flex-direction:row; justify-content:space-around; height:5vh;">
                              <p>BIO</p>
                              <input type="checkbox" id="bioounon">
                              <p id="bio_temoin">Non</p>
                            </div>
                    </div>

          <style>
            #legende {
              opacity:0.5;
              display:flex;
              position:absolute;
              top:40%;
              left:95%;
              height:20%;
              width:10%;
              z-index:2500;
              background-color:white;
            }
            #legende:hover {
              opacity:1;
              transform: translateX(-60%);
            }
            .dot {
              height: 100%;                /* Taille du point */
              aspect-ratio: 1 / 1;
              border-radius: 50%; 
            }
             #bio_block {
                display: none;
              }
            
              /* afficher quand on survole #cereale_input */
              #cereale_input:hover #bio_block {
                display: flex;
              }
          </style>
          
          <div id="panel_F">
            <div id="panel_F_circle" class="circleC">
            <img id="panel_F_img" src="https://cdn.pixabay.com/photo/2012/04/02/12/33/truck-24360_1280.png" alt="photoconduc">
             </div>
            <div style="display:flex; flex-direction:column">
            <p id="panel_F_p">Posée par MONIER B.</p><br>
            <p id="panel_F_pb">27/08/2025 à 14h10</p>
            </div>
          </div>

          <div id="panel_I">
            <div class="w3-center" style="justify-content:space-around; display:flex; flex-direction:row">
            <p>Latitude</p>
            <p id="panel_I_lat">45.4578191</p>
            </div>
            <div class="w3-center" style="justify-content:space-around; display:flex; flex-direction:row">
            <p>Longitude</p>
            <p id="panel_I_lon">4.255457</p>
            </div>
            <div class="w3-center" style="justify-content:space-around; display:flex; flex-direction:row">
            <p>Altitude</p>
            <p id="panel_I_alt">453 m</p>
            </div>
          </div>

          
          <div id="panel_J">
            <button id="move_benne">Déplacer la benne</button>
          </div>
          
          <div id="panel_G">
            <button id="panel_G_button" onclick="window.open('fleuread.onrender.com/historique?type=benne&id=455', '_blank');">Voir l'historique</button>
          </div>

          <div id="panel_K">
            <button onclick="showAdmin()">Voir dans la console d'administration</button>
          </div>
        </div>
      </div>
      <div id="view">
        <div id="mapSearch">
          <input id="mapSearch_input" placeholder="Entrez un numéro de benne ou une adresse pour commencer à chercher...">
          <div id="result_mapSearch"></div>
        </div>
        <div id="mapA">
          
        </div>
      </div>
    </div>
    <div style="display:none" id="admin">
      <div id="selecter">
        <button onclick="document.getElementById('bennesSearch').style.display='flex';document.getElementById('comptesSearch').style.display='none';document.getElementById('clientsSearch').style.display='none'; putBennes('no'); document.getElementById('cerealesSearch').style.display='none';document.getElementById('infosSearch').style.display='none'; setForBennes();" id="btnBennes">Bennes</button>
        <button onclick="document.getElementById('bennesSearch').style.display='none';document.getElementById('comptesSearch').style.display='flex';document.getElementById('clientsSearch').style.display='none';  putComptes('no'); document.getElementById('cerealesSearch').style.display='none';document.getElementById('infosSearch').style.display='none'; setForComptes();" id="btnComptes">Comptes</button>
        <button onclick="document.getElementById('bennesSearch').style.display='none';document.getElementById('comptesSearch').style.display='none';document.getElementById('clientsSearch').style.display='flex'; putClients('no'); document.getElementById('cerealesSearch').style.display='none';document.getElementById('infosSearch').style.display='none'; setForClients();" id="btnClients">Clients</button>
        <button onclick="document.getElementById('bennesSearch').style.display='none';document.getElementById('comptesSearch').style.display='none';document.getElementById('clientsSearch').style.display='none'; putCereales('no'); document.getElementById('cerealesSearch').style.display='flex';document.getElementById('infosSearch').style.display='none'; setForCereales();" id="btnCereales">Céréales</button>
        <button onclick="document.getElementById('bennesSearch').style.display='none';document.getElementById('comptesSearch').style.display='none';document.getElementById('clientsSearch').style.display='none'; putParams('no'); document.getElementById('cerealesSearch').style.display='none';document.getElementById('infosSearch').style.display='flex'; setForParams();" id="btnInfos">Paramètres</button>
      </div>
      <div id="bennesSearch">
              <div id="searcherBenne">
                <input class='input_search' type="text" id="text_searcherBenne" placeholder="Recherchez une benne ici...">
                <div>
                  <button style="background-color:yellow;" onclick="document.getElementById('text_searcherBenne').value = 'STAT$POS'; putBennes(document.getElementById('text_searcherBenne').value);">Posée(s)</button>
                  <button style="background-color:red;" onclick="document.getElementById('text_searcherBenne').value = 'STAT$PRE'; putBennes(document.getElementById('text_searcherBenne').value);">Prête(s)</button>
                  <button style="background-color:blue;" onclick="document.getElementById('text_searcherBenne').value = 'STAT$END'; putBennes(document.getElementById('text_searcherBenne').value);">En dépôt</button>
                </div>
                <button id="filtrerBennes" onclick="putBennes(document.getElementById('text_searcherBenne').value);">Filtrer</button>
                <button onclick="putBennes('no'); document.getElementById('text_searcherBenne').value = '';">Réinitialiser</button>
                <progress id="benne_progress" value="0" max="100"></progress>
              </div>
        <div class="scroll-container" id="bennesScroller">
          <div id="bennesContent"></div> <!-- C'est ici qu'on va insérer les bennes. Il faut savoir qu'on doit récupérer les bennes sous forme de liste, les insérer et quand on fait une recherche, on refait le protocole d'insertion sans le filtre-->
        </div>
        <form id="createBenne">
          <input class="input_search" type="text" name="num" placeholder="N° de la Benne" required>
          <input class="input_search" type="number" name="volume" placeholder="Capacité (T)" required>
          <button type="submit">Créer une benne</button>
        </form>
      </div>
      <div style="display:none" id="comptesSearch">
        <div id="searcherCompte">
                <input class='input_search' type="text" id="text_searcherCompte" placeholder="Recherchez un compte ici...">
                <button id="filtrerComptes" onclick="putComptes(document.getElementById('text_searcherCompte').value);">Filtrer</button>
                <button onclick="putComptes('no'); document.getElementById('text_searcherCompte').value = '';">Réinitialiser</button>
                <progress id="compte_progress" value="0" max="100"></progress>
              </div>
        <div class="scroll-container" id="comptesScroller">
          <div id="comptesContent"></div> <!-- C'est ici qu'on va insérer les comptes. Il faut savoir qu'on doit récupérer les bennes sous forme de liste, les insérer et quand on fait une recherche, on refait le protocole d'insertion sans le filtre-->
        </div>
         <form id="createCompte">
          <input class="input_search" type="text" name="first_name" placeholder="Prénom" required>
          <input class="input_search" type="text" name="name" placeholder="NOM" required>
          <button type="submit">Créer un compte</button>
        </form>
      </div>
      <div style="display:none" id="clientsSearch">
        <div id="searcherClient">
                <input class='input_search' type="text" id="text_searcherClient" placeholder="Recherchez un client ici...">
                <button id="filtrerClients" onclick="putClients(document.getElementById('text_searcherClient').value);">Filtrer</button>
                <button onclick="putClients('no'); document.getElementById('text_searcherClient').value = '';">Réinitialiser</button>
                <progress id="client_progress" value="0" max="100"></progress>
              </div>
        <div class="scroll-container" id="clientsScroller">
          <div id="clientsContent"></div> <!-- C'est ici qu'on va insérer les clients. Il faut savoir qu'on doit récupérer les bennes sous forme de liste, les insérer et quand on fait une recherche, on refait le protocole d'insertion sans le filtre-->
        </div>
        <form id="createClient">
          <input class="input_search" type="text" name="name" placeholder="Nom de l'exploitation" required>
          <input class="input_search" type="tel" name="phonenumber" placeholder="N° de Tel." required>
          <button type="submit">Créer un client</button>
        </form>
      </div>
      <div style="display:none" id="cerealesSearch">
        <div id="searcherCereale">
                <input class='input_search' type="text" id="text_searcherCereale" placeholder="Recherchez une céréale ici...">
                <button id="filtrerCereales" onclick="putCereales(document.getElementById('text_searcherCereale').value);">Filtrer</button>
                <button onclick="putCereales('no'); document.getElementById('text_searcherCereale').value = '';">Réinitialiser</button>
                <progress id="cereale_progress" value="0" max="100"></progress>
              </div>
        <div class="scroll-container" id="cerealesScroller">
          <div id="cerealesContent"></div> <!-- C'est ici qu'on va insérer les céréales. Il faut savoir qu'on doit récupérer les bennes sous forme de liste, les insérer et quand on fait une recherche, on refait le protocole d'insertion sans le filtre-->
        </div>
        <form id="createCereale">
          <input class="input_search" type="text" name="name" placeholder="Nom de la céréale" required>
          <button type="submit">Créer une céréale</button>
        </form>
      </div>
      <div style="display:none" id="infosSearch">
        <div id="searcherParam">
                <input class='input_search' type="text" id="text_searcherParam" placeholder="Recherchez un paramètre ici...">
                <button id="filtrerParams" onclick="putParams(document.getElementById('text_searcherParam').value);">Filtrer</button>
                <button onclick="putParams('no'); document.getElementById('text_searcherParam').value = '';">Réinitialiser</button>
                <progress id="param_progress" value="0" max="100"></progress>
              </div>
        <div class="scroll-container" id="infosScroller">
          <div id="infosContent"></div> <!-- C'est ici qu'on va insérer les informations. Il faut savoir qu'on doit récupérer les bennes sous forme de liste, les insérer et quand on fait une recherche, on refait le protocole d'insertion sans le filtre-->
        </div>
        <div id="searcherParamB">
              </div>
      </div>
    </div>
    <style>
      .scroll-container {
        height:90%;
        width:100%;
        overflow-y:auto;
        overflow-x:auto;
        padding:1vw;
        background:grey;
      }
      #panel_A {
        position:relative;
        width:100%;
      }
      #panel_A_img {
        width:100%;
      }
      #panel_A_h1 {
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        color:white;
      }
      .cropped-image {
      height: 15vh;
      object-fit: cover;      /* croppe l'image pour remplir le conteneur */
      object-position: center; /* zone visible centrée */
      }

      #panel_E, #panel_F {
        display:flex;
        flex-direction:row;
        justify-content:space-around;
        align-items:center;
      }

       #panel_E_circle, #panel_F_circle {
        height:25%;
        align-items:center;
        width:25%;
      }

      #panelcontent > div {
    margin: 0.5rem 0;         /* espace extérieur (haut/bas) */
    padding: 0.5rem;          /* espace intérieur */
    border: 1px solid #ccc;   /* fine bordure grise */
    border-radius: 0.5rem;    /* coins arrondis (optionnel) */
    background-color: white;  /* fond clair (optionnel) */
    }
      
      #map {
        position:fixed;
        top:10vh;
        height:90vh;
        width:100vw;
        display:flex;
        flex-direction:row;
      }
      #admin {
        position:fixed;
        top:10vh;
        height:90vh;
        width:100vw;
        display:flex;
        flex-direction:column;
      }

      #panelcontent {
        overflow-y:auto;
      }
      .input_search {
        height:2vh;
        width:25vh;
      }
      #bennesSearch, #comptesSearch, #clientsSearch, #cerealesSearch, #infosSearch {
        top:15vh;
        height:85vh;
        flex-direction:column;
      }
      #mapSearch {
        position:absolute;
        top:2vh;
        left:15vh;
        width:70vh;
        z-index:2000;
        flex-direction:column;
      }
      #result_mapSearch {
        max-height:20vh;
        overflow-y:auto;
      }
      #selecter, #searcherBenne, #createBenne, #createCompte, #searcherCompte, #createClient, #searcherClient, #createCereale, #searcherCereale, #createParam, #searcherParam, #searcherParamB {
        width:100%;
        height:5%;
        background:linear-gradient(90deg, black, grey);
        align-items:center; /* We center everything in height */
        justify-content:space-between; /* Distribue l'espace horizontalement */
        display:flex;
        padding: 0 1rem;
        box-sizing: border-box;
      }
      #view {
        flex:1;
        height:100%;
        background:lightgray;
      }
       #panel {
        width:40%;
        height:100%;
        background:grey;
        flex-direction:column;
      }
      #mapA {
        height:100%;
        width:100%;
        margin:0;
        padding:0;
      }

       .leaflet-control-layers {
      z-index:1001;
    }

      #mapSearch_input {
        background-color:rgba(255,255,255,0.5);
      }
      
      body {
          margin: 0;
          padding:1rem;
          height: 100vh;
          width: 100vw;
          display:flex;
          justify-content:center; /* aligné à l'horizontal */
          align-items:center; /* aligné en vertical */
          background: linear-gradient(135deg, blue, yellow);
          font-family: Arial, sans-serif;
           box-sizing:border-box; 
      }
      .form-container {
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          width:100%;
          height:auto;
          max-width:400px;
          box-shadow: 0 8px 20px rgba(0,0,0,0.7);
         box-sizing:border-box;
      }
      input {
        width: 100%;
        padding: 0.75rem;
       /* margin-bottom: 1rem; */
        border: 1px solid #ccc;
        border-radius: 0.5rem;
        font-size: 1rem;
        box-sizing:border-box; 
      }
      button {
        
        
        background-color:blue;
        color:white;
       
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor:pointer;
        transition:background 0.3s ease;
       box-sizing:border-box;
      }
      button:hover {
        background-color:red;
      }
      .img {
        max-width:80%;
        height:auto;
       box-sizing:border-box;
        margin:0.5rem;
      }
      .head {
        background:linear-gradient(90deg, black, grey);
        display:flex;
        position:fixed; /* Fixed is better than absolute as it fix the position even when scolling */
        top:0;
        left:0; /* We'll take the left side as a spot better than the right one */
        width:100%;
        height:10vh;
        align-items:center; /* We center everything in height */
        justify-content:space-between; /* Distribue l'espace horizontalement */
        padding:0 1rem; /* Espace entre bordure et contenu */
        box-sizing:border-box;
        color:white;
        font-weight:bold; /* Police d'écriture en gras */
        z-index:1000;
      }
      .circle {
        width:5vh;
        height:5vh;
        border-radius:50%;
        overflow:hidden;
        position:relative;
      }

           .circleC {
        height: 100%;         /* prend toute la hauteur disponible */
        aspect-ratio: 1 / 1;
        border-radius:50%;
        overflow:hidden;
        position:relative;
      }

      .circleB {
        width:15vh;
        height:15vh;
        border-radius:50%;
        overflow:hidden;
        position:relative;
      }
       .circle img, .circleB img, .circleC img {
        width:100%;
        height:100%;
        object-fit:cover;
        position:absolute;
        top:50%;
        left:50%;
        transform: translate(-50%,-50%);
      }
      #heure, #portal, #logo_eurea, #compte, #visuBtn, #adminBtn {
        display:flex;
        align-items:center;
        white-space:nowrap; /* Forcer le texte à rester sur une seule ligne */
      }
  
      #logo_eurea img {
        height:6vh;
        cursor:pointer;
      }

      #compte p {
        margin:0;
        font-size:1rem;
        margin-left:2vh;
      }

      @media (max-width: 680px) { /* Ce qui se cache sur la version mobile */
         #heure, #portal, #logo_eurea {
           display:none;
         }
        button {
          font-size:0.75rem;
        } 
      }
    </style>
    <script>
const offset = -((new Date().getTimezoneOffset()) / 60);
      console.log(offset);
      
          async function start() {
      url = new URL(window.location.href);
      sessionId = await sessionStorage.getItem('session_id');
      if (!sessionId) {
        console.log("Not connected");
        window.location.href = `https://${url.hostname}`; 
      } else {
        if (await check(sessionId)) {
        console.log("Connected");
       await connectWebSocket();
          await getMe();
        } else {
        sessionStorage.removeItem('session_id');
        console.log("Not connected");
        window.location.href = `https://${url.hostname}`; 
        }
      }
            plotPoints();
      }
      
      start();

      
      async function check(id) {
        const answer = await fetcher('checksession',{'id':id},'POST','noauth');
        const bool = answer.value;
        console.warn(bool);
        if (bool) {
          console.warn("true");
          return true;
        } else {
          console.warn("false");
          return false;
        }
      }

      async function fetcher (endpoint, body, method, auth) {
        try {
        const response = await fetch(`https://${url.host}/${endpoint}`,{
          'method':method,
          'headers' : {
            'Content-Type':'application/json',
            'auth': auth
          }, 
          'body' : JSON.stringify(body)
        });
        const data = await response.json();
          return data;
        } catch (err) {return err;}
      }

      let socket;
      // Ici on gère la technologie websocket
      async function connectWebSocket() {
        if (socket && socket.readyState === WebSocket.OPEN) {
          return;
        }
        socket = new WebSocket (`wss://${url.host}?key=${sessionStorage.getItem('session_id')}&offset=${offset}`);
        socket.addEventListener('open', () => {
               // console.log("Connecté au serveur websocket !");
          socket.send(JSON.stringify({action:"SET", offset:offset}));
        });
        socket.addEventListener("message", (event) => {
        mes = JSON.parse(event.data);
        if (mes.action === 'time') {
          document.getElementById('time').textContent = mes.value;
        }
           if (mes.action === 'benstatus') {
          if (mes.who === sessionStorage.getItem('session_id')) {
            console.log(parseFloat(mes.value)*100);
            document.getElementById('benne_progress').value = parseFloat(mes.value)*100;
          }
             
      }
        if (mes.action === 'comstatus') {
          if (mes.who === sessionStorage.getItem('session_id')) {
            console.log(parseFloat(mes.value)*100);
            document.getElementById('compte_progress').value = parseFloat(mes.value)*100;
          }
        }
           if (mes.action === 'clistatus') {
          if (mes.who === sessionStorage.getItem('session_id')) {
            console.log(parseFloat(mes.value)*100);
            document.getElementById('client_progress').value = parseFloat(mes.value)*100;
          }
        }
            if (mes.action === 'cerstatus') {
          if (mes.who === sessionStorage.getItem('session_id')) {
            console.log(parseFloat(mes.value)*100);
            document.getElementById('cereale_progress').value = parseFloat(mes.value)*100;
          }
        }
            if (mes.action === 'parstatus') {
          if (mes.who === sessionStorage.getItem('session_id')) {
            console.log(parseFloat(mes.value)*100);
            document.getElementById('param_progress').value = parseFloat(mes.value)*100;
          }
        }
            if (mes.action === 'disconnect') {
              console.log("A/B");
              console.log(mes.who);
          if (mes.who === localStorage.getItem('offtoken')) {
            console.log("B/B");
          disconnect();
          }
        }

                            if (mes.action === 'reload') {
                        if (mes.what === "benne") {
                          reloadBenne();
                        }
                               if (mes.what === "compte") {
                          start();
                        }
                      }
        });
      }

let mydatas = {};
let generalDatas;
      
      async function getMe() {
        const answer = await fetcher('getme',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
        const icon = answer.icon;
        const first_name = answer.first_name;
        const name = answer.name;
        const role = answer.role;
        document.getElementById('myPict').src = icon;
        document.getElementById('myName').textContent = `${first_name} ${name}`;
        mydatas["icon"] = icon;
        mydatas["first_name"] = first_name;
        mydatas["name"] = name;
        mydatas["role"] = role;
       // getGeneralDatas();
      }

       async function getGeneralDatas() {
        const answer = await fetcher('getgeneraldatas',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
        generalDatas = answer;
        console.log(generalDatas);
      }
    </script>
    <style>
      #lightbox, #lightboxB {
        position:fixed;
        top:0;
        left:0;
        height:100vh;
        width:100vw;
        background:rgba(100,100,100,0.7);
        display:none;
        justify-content:center;
        align-items:center;
        z-index:1000;
      }
       .lightbox-content {
       background:white;
        padding:2em;
         border-radius:12px;
         text-align:center;
         max-width:400px;
         width:80%;
         position:relative;
         box-shadow: 0 0 15px rgba(0,0,0,0.3);
      }
      #close-btn, #close-btnB {
        position:absolute;
        top:10px;
        right:15px;
        font-size:1.8em;
        cursor:pointer;
        color:red;
      }
      .line {
        width:100%;
        height:10vh;
        display:flex;
        flex-direction:row;
        background:linear-gradient(135deg, white, blue);
        border: 1vh solid black;
        margin-top:1vh;
        align-items:center;
        justify-content: space-between;
        padding: 0.5rem;
      }
    </style>
     <script>
       const profilePic = document.getElementById('compte');
       const lightbox = document.getElementById('lightbox');
       const closeBtn = document.getElementById('close-btn');
       document.addEventListener('DOMContentLoaded', () => {
       profilePic.addEventListener('click', () => {
         lightbox.style.display = 'flex';
         document.getElementById('lightH2').textContent = mydatas["first_name"] + " " + mydatas["name"];
         document.getElementById('lightImg').src =  mydatas["icon"];
         document.getElementById('lightP').textContent =  mydatas["role"];
       });
        closeBtn.addEventListener('click', () => {
         lightbox.style.display = 'none';
       });
       lightbox.addEventListener('click', (e) => {
         if (e.target === lightbox) {
           lightbox.style.display = 'none';
         }
       });
       });
     </script>
    <script>
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });
    const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap' });
    
    const baseMaps = {
  "OpenStreetMap": osm,
  "Satellite": satellite,
      "Topographie":topo
  };
    
    const map = L.map('mapA').setView([45.72191877191547, 4.227417998761897], 15);
    L.control.layers(baseMaps, null, {position:'bottomleft'}).addTo(map);
    osm.addTo(map);
      setTimeout(() => {
      map.invalidateSize();
      }, 300);

 map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // Afficher les coordonnées
  console.log(`Latitude: ${lat.toFixed(6)}, Longitude: ${lon.toFixed(6)}`);
   if (changerState) {
     showToast("Nouvelle position enregistrée.", "green");

     const content = {
                  altitude:"Inconnue",
                  latitude:lat,
                 longitude:lon,
                 id:nowPanel
              };
              console.log(content);
              fetcher('registerbenne', content, 'POST', sessionStorage.getItem('session_id'));
     changerState = false;
   }
  });
      
async function translateColor (input) {
  if (input == "A") {
    return "yellow";
  }
  if (input == "B") {
    return "red";
  }
  if (input == "C") {
    return "blue";
  }
}
      
    const markers = [];
      
      async function plotPoints () {
        // On possède les données
        // await getGeneralDatas();
        const pointBennes = await getBennes();
        // On enlève d'abord tous les marqueurs
           for (const marker of markers) {
             map.removeLayer(marker);
           }
        markers.length = 0;
        // 
        for (const benne of pointBennes) {
          console.log("Plotting de la benne n° ", benne.id);
          if (benne.longitude && benne.latitude) {
            console.log("Coordonnées : ", benne.longitude, ", ", benne.latitude);
            console.log(benne.status, " → ", await translateColor(benne.status));
          const marker = L.circleMarker([benne.longitude, benne.latitude], {
            radius:10,
            color:await translateColor(benne.status),
            fillColor:await translateColor(benne.status),
            fillOpacity:0.8
          })
          .addTo(map)
          .bindPopup(benne.id.toString())
          marker.on('click', function(e) {
            console.log(`La benne n° ${e.target.getPopup().getContent()} a été cliquée, nous allons afficher ses informations dans le panneau latéral`);
            pushPanel(e.target.getPopup().getContent());
          });
            markers.push(marker);
        }
        }
      }

      async function focusOn(text, position) {
             map.flyTo([position.lat, position.lon], 12, {
                  duration: 3,        
                  easeLinearity: 0.25 
                });
        const focus = L.marker([position.lat, position.lon]).addTo(map);
        focus.bindPopup(text).openPopup();
      };

      async function getBennes() {
        return await fetcher('getbennes',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
      }

      async function putBennes(filtre) {
        document.getElementById("registerPop").onclick = () => logModification();
        await setForBennes ();
        console.log("Appel d'un putBennes...");
        const bennes = await getBennes();
        console.log(bennes);
        let filtered = [];
        if (filtre !== 'no') {
        filtered = await filter(bennes, filtre);
        } else {
        filtered = bennes;
        }
        console.log("Le système a filtré la liste :");
        console.log(filtered);
        const bennesContainer = document.getElementById('bennesContent');
        bennesContainer.innerHTML = "";
        console.log("On va traiter l'ajout...");
        for (const ben of filtered) {
          console.log("Création d'une benne :", ben);
          const line = document.createElement('div');
          line.classList.add('line');
          line.id = `B${ben.id}`;
benDatas[ben.id] = ben;
       const lightbox = document.getElementById('lightboxB');
       const closeBtn = document.getElementById('close-btnB');
        const imagePop = document.getElementById('lightImgB');
      console.log("LIGHTBOX");
      line.addEventListener('click', () => {
         lightbox.style.display = 'flex';
        console.log("Lien image :", ben.link);
        document.getElementById('imagePop').src = ben.link;
         document.getElementById('lightH2B').textContent = "Benne n°" + ben.id;
         document.getElementById('lightPB').textContent =  ben.volume + " T | " + ben.notes;
        const statusReadable = toread(ben.status);
        console.log(statusReadable);
        document.getElementById('lightPB3').innerHTML =  "<strong>" + statusReadable.charAt(0).toUpperCase() + statusReadable.slice(1) + "</strong> chez <strong>" + ben.ferme + "</strong> en <strong>" + ben.formatted_cereale + "</strong>";
         popAdresse(ben.adresse);
        numon = ben.id;
        console.log(numon);
        document.getElementById('editeurLightBenne').style.display == 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
        closeBtn.addEventListener('click', () => {
         lightbox.style.display = 'none';
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
       lightbox.addEventListener('click', (e) => {
         if (e.target === lightbox) {
           lightbox.style.display = 'none';
             document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
         }
       });
    
          
          const num = document.createElement('h1');
          num.textContent = ben.id;
          num.style.backgroundColor = tocolor(ben.status);
          line.append(num);
          const status = document.createElement('p');
          status.textContent = ben.ferme;
          // status.style.backgroundColor = tocolor(ben.status);
          line.append(status);
          
          const pds = document.createElement('p');
          pds.textContent = ben.formatted_cereale;
          line.append(pds);
          
          const notes = document.createElement('p');
          notes.textContent = short(ben.notes);
          line.append(notes);

          const but2 = document.createElement('button');
          but2.textContent = `Carte`;
          but2.addEventListener('click', function (event) {
            event.stopPropagation();
            showMap(ben.id);
          });
        //  but2.onclick = () => {
           // showMap (ben.id);
           // }
          line.append(but2);
          
          const but = document.createElement('button');
          but.textContent = `QR-Code`;
          but.addEventListener('click', function (event) {
            event.stopPropagation();
            window.open(`https://fleuread.onrender.com/generate?what=QR&id=${ben.id}`,'_blank');
          });
          // but.onclick = () => {
           // window.open(`https://fleuread.onrender.com/generate?what=QR&id=${ben.id}`,'_blank');
           // }
          line.append(but);
          bennesContainer.append(line);
        }
      }

      async function filter (what, filtre) {
        console.log("Appel d'un filtre");
        console.log("Avant :", what);
        const query = filtre.toLowerCase();
        return what.filter(obj => Object.values(obj).some(val => String(val).toLowerCase().includes(query)));
      }

      function short(str) {
        if (str.length > 50) {
      return str.slice(0, 50) + "...";    
        } else {
      return str;
        }
      }

      function tocolor(statut) {
        if (statut == "A") {
          return 'yellow';
        }
         if (statut == "B") {
          return 'red';
        }
         if (statut == "C") {
          return 'blue';
        }
      }
      function toread(statut) {
        if (statut == "A") {
          return 'posée';
        }
         if (statut == "B") {
          return 'prête';
        }
         if (statut == "C") {
          return 'en dépôt';
        }
      }
      function toreadOpt(statut) {
        if (statut == "volume") {
          return 'Capacité (T)';
        }
         if (statut == "notes") {
          return 'Indications';
        }
         if (statut == "latitude") {
          return 'Longitude';
        }
           if (statut == "longitude") {
          return 'Latitude';
        }
           if (statut == "statut") {
          return 'État';
        }
         if (statut == "password") {
          return 'Mot de passe';
        }
         if (statut == "first_name") {
          return 'Prénom';
        }
        if (statut == "code") {
          return 'Code';
        }
        if (statut == "photo") {
          return "Image d'illustration";
        }
         if (statut == "name") {
          return 'Nom';
        }
        if (statut == "phonenumber") {
          return 'Informations de contact';
        }
         if (statut == "auth") {
          return 'Rôle dans la société';
        }
          if (statut == "admin") {
          return 'Administrateur';
        }
          if (statut == "driver") {
          return 'Conducteur';
        }
          if (statut == "value") {
          return 'Valeur';
        }
      }

 let numon;
      document.getElementById('createBenne').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = await Object.fromEntries(formData.entries());
        const content = {
          num:data.num,
          volume:data.volume
        };
        const fromServer = await fetcher('createbenne', content, 'POST', sessionStorage.getItem('session_id'));
        showToast(`Création de la benne n°${data.num} !`);
        putBennes('no');
        document.getElementById('createBenne').reset();
      });

      async function deleteBenne(num) {
        console.log(numon)
        if (confirm(`Supprimer la benne n°${numon} ?`)) {
          if(confirm("Confirmez pour la dernière fois... Cette action est irréversible")) {
        const content = {
          num:num
        };
        const fromServer = await fetcher('deletebenne', content, 'POST', sessionStorage.getItem('session_id'));
            showToast(`Suppression effective (Benne n°${numon}) !`);
        putBennes('no');
          }}
      }

const benDatas = {};
const comDatas = {};
const cliDatas = {};
const cerDatas = {};
const paramDatas = {};
let what;
      
      async function setForBennes () {
        what = "benne";
        selecterInput = [
        "volume",
        "notes",
        "latitude",
        "longitude",
        "statut"
        ];
        statusOpt = [
        {name:"Posée", value:"A", color:'yellow'},
        {name:"Prête",value:"B", color:'red'},
        {name:"En dépôt", value:"C", color:'blue'} // <button id="deleter" onclick="deleteBenne(numon)">Supprimer</button>
      ];
        setEditable();
        document.getElementById('deleter').onclick = () => {
          deleteBenne(numon)
        }
      }

        async function setForComptes () {
        what = "compte";
        selecterInput = [
        "password",
        "name",
        "first_name",
        "auth"
        ];
          statusOpt = [
        {name:"Conducteur", value:"driver", color:'green'},
        {name:"Administrateur",value:"admin", color:'blue'},
      ];
          setEditable();
          document.getElementById('deleter').onclick = () => {
          deleteCompte(numon)
        }
      }

      async function setForClients () {
        what = "client";
        selecterInput = [
        "phonenumber",
        "name",
        "latitude",
        "longitude",
        "notes"
        ];
          statusOpt = [
        {name:"Conducteur", value:"driver", color:'green'},
        {name:"Administrateur",value:"admin", color:'blue'},
      ];
          setEditable();
          document.getElementById('deleter').onclick = () => {
          deleteClient(numon)
        }
      }

            async function setForCereales () {
        what = "cereale";
        selecterInput = [
        "photo",
        "name",
        "code"
        ];
          statusOpt = [
        {name:"Conducteur", value:"driver", color:'green'},
        {name:"Administrateur",value:"admin", color:'blue'},
      ];
          setEditable();
          document.getElementById('deleter').onclick = () => {
          deleteCereale(numon)
        }
      }

         async function setForParams () {
        what = "param";
        selecterInput = [
        "value"
        ];
          statusOpt = [
        {name:"Conducteur", value:"driver", color:'green'},
        {name:"Administrateur",value:"admin", color:'blue'},
      ];
          setEditable();
          document.getElementById('deleter').onclick = () => {
          deleteParam(numon)
        }
      }
      
      
      const selecter = document.getElementById('modifierSelecter');
        let selecterInput = [
        "volume",
        "notes",
        "latitude",
        "longitude",
        "statut"
        ];

      let statusOpt = [
        {name:"Posée", value:"A", color:'yellow'},
        {name:"Prête",value:"B", color:'red'},
        {name:"En dépôt", value:"C", color:'blue'}
      ];
      async function setEditable() {
        selecter.innerHTML = "";
        const option = document.createElement('option');
          option.value = "no";
          option.text = "Sélectionnez un paramètre";
          option.disabled = true;
          selecter.append(option);
        for (const item of selecterInput) {
          const option = document.createElement('option');
          option.value = item;
          option.text = toreadOpt(item);
          selecter.append(option);
        }
      }
        selecter.addEventListener('change', (event) => {
          console.log(benDatas);
          const value = event.target.value;
          console.log("Change ", value);
          if (value == "statut") {
            console.log(true);
            document.getElementById('inpSelecter').style.display = "none";
            document.getElementById('suggester').style.display = "flex";
            document.getElementById('suggester').innerHTML="";
            for (const opt of statusOpt) {
              const button = document.createElement('button');
              button.textContent = opt.name;
              button.onclick = () => {
                selecter.selectedIndex = 5;
                document.getElementById('inpSelecter').value = opt.value;
                document.getElementById('registerPop').click();
              }
              button.style.color = "black";
              button.classList.add("button_status");
              button.style.backgroundColor = opt.color;
              document.getElementById('suggester').append(button);
            }
          } else if (value == "auth") {
            console.log(true);
            document.getElementById('inpSelecter').style.display = "none";
            document.getElementById('suggester').style.display = "flex";
            document.getElementById('suggester').innerHTML="";
            for (const opt of statusOpt) {
              const button = document.createElement('button');
              button.textContent = opt.name;
              button.onclick = () => {
                selecter.selectedIndex = 4;
                document.getElementById('inpSelecter').value = opt.value;
                document.getElementById('registerPop').click();
              }
              button.style.color = "black";
              button.classList.add("button_status");
              button.style.backgroundColor = opt.color;
              document.getElementById('suggester').append(button);
            }
          } else {
            document.getElementById('inpSelecter').style.display = "flex"
            document.getElementById('suggester').style.display = "none";
            document.getElementById('suggester').innerHTML = "";
          }
          if (what == "benne") {
          document.getElementById('inpSelecter').value = benDatas[numon][value];
          } else if (what == "compte") {
           document.getElementById('inpSelecter').value = comDatas[numon][value]; 
          } else if (what == "client") {
           document.getElementById('inpSelecter').value = cliDatas[numon][value]; 
          } else if (what == "cereale") {
           document.getElementById('inpSelecter').value = cerDatas[numon][value]; 
          } else if (what == "param") {
           document.getElementById('inpSelecter').value = paramDatas[numon][value]; 
          }
        });
    </script>
    <script>
      async function checkWebSocket() {
        if (!socket || socket.readyState == WebSocket.CLOSED ||  socket.readyState == WebSocket.CLOSING) {
          console.log("WebSocket Inactif !");
          window.location.reload();
        } else {
          console.log("WebSocket Actif !");
        }
      }
      setInterval(checkWebSocket, 15*1000);

      async function resizeMap () {
        document.getElementById('mapSearch').style.display = "flex";
        document.getElementById('panel').style.display = "flex";

        setTimeout(() => {
        document.getElementById('panel').style.display = "none";
        }, 10);
      }
      resizeMap();

      async function logModification () {
        const parameterToChange = selecter.value;
        const affSelecter = selecter.options[selecter.selectedIndex].text;
        console.log("affSelecter :", affSelecter);
        const value = document.getElementById('inpSelecter').value;
        const num = numon;
        const content = {
          toupd : parameterToChange,
          value_toupd : value,
          eq:'num',
          value_eq:num
        };
        console.log(content);
        const fromServer = await fetcher('editbenne', content, 'POST', sessionStorage.getItem('session_id'));
        setTimeout(() => {
        document.getElementById(`B${numon}`).click();
        }, 500);
        showToast(`Modification enregistrée (Benne n°${numon} - ${affSelecter}) !`);
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
        document.getElementById('inpSelecter').value = "";
        document.getElementById('filtrerBennes').click();
      }
      async function logModificationB () {
        const parameterToChange = selecter.value;
        const affSelecter = selecter.options[selecter.selectedIndex].text;
        console.log("affSelecter :", affSelecter);
        const value = document.getElementById('inpSelecter').value;
        const num = numon;
        const content = {
          toupd : parameterToChange,
          value_toupd : value,
          eq:'num',
          value_eq:num
        };
        console.log(content);
        const fromServer = await fetcher('editcompte', content, 'POST', sessionStorage.getItem('session_id'));
        setTimeout(() => {
        document.getElementById(`C${numon}`).click();
        }, 500);
        showToast(`Modification enregistrée (Compte n°${numon} - ${affSelecter}) !`);
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
        document.getElementById('inpSelecter').value = "";
        document.getElementById('filtrerComptes').click();
      }
      async function logModificationC () {
        const parameterToChange = selecter.value;
        const affSelecter = selecter.options[selecter.selectedIndex].text;
        console.log("affSelecter :", affSelecter);
        const value = document.getElementById('inpSelecter').value;
        const num = numon;
        const content = {
          toupd : parameterToChange,
          value_toupd : value,
          eq:'num',
          value_eq:num
        };
        console.log(content);
        const fromServer = await fetcher('editclient', content, 'POST', sessionStorage.getItem('session_id'));
        setTimeout(() => {
        document.getElementById(`D${numon}`).click();
        }, 500);
        showToast(`Modification enregistrée (Client n°${numon} - ${affSelecter}) !`);
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
        document.getElementById('inpSelecter').value = "";
        document.getElementById('filtrerClients').click();
      }
      async function logModificationD () {
        const parameterToChange = selecter.value;
        const affSelecter = selecter.options[selecter.selectedIndex].text;
        console.log("affSelecter :", affSelecter);
        const value = document.getElementById('inpSelecter').value;
        const num = numon;
        const content = {
          toupd : parameterToChange,
          value_toupd : value,
          eq:'num',
          value_eq:num
        };
        console.log(content);
        const fromServer = await fetcher('editcereale', content, 'POST', sessionStorage.getItem('session_id'));
        setTimeout(() => {
        document.getElementById(`E${numon}`).click();
        }, 500);
        showToast(`Modification enregistrée (Céréale n°${numon} - ${affSelecter}) !`);
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
        document.getElementById('inpSelecter').value = "";
        document.getElementById('filtrerCereales').click();
      }
      async function logModificationE () {
        const parameterToChange = selecter.value;
        const affSelecter = selecter.options[selecter.selectedIndex].text;
        console.log("affSelecter :", affSelecter);
        const value = document.getElementById('inpSelecter').value;
        const num = numon;
        const content = {
          toupd : parameterToChange,
          value_toupd : value,
          eq:'num',
          value_eq:num
        };
        console.log(content);
        const fromServer = await fetcher('editparam', content, 'POST', sessionStorage.getItem('session_id'));
        setTimeout(() => {
        document.getElementById(`F${numon}`).click();
        }, 500);
        showToast(`Modification enregistrée (Paramètre n°${numon} - ${affSelecter}) !`);
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
        document.getElementById('inpSelecter').value = "";
        document.getElementById('filtrerParams').click();
      }
    </script>
    <style>
      #toast-container {
        position:fixed;
        bottom:2vh;
        right:2vw;
        z-index:9999;
        display:flex;
        flex-direction:column;
        gap:1vh;
      }
      .toast {
        background-color:#4CAF50;
        color:white;
        padding: 1rem 1.5rem;
        border-radius:5px;
        font-size:1rem;
        box-shadow: 0 0 10px;
        animation:fadein 0.5s, fadeout 0.5s 14.5s;
        opacity:0;
        animation-fill-mode:forwards;
      }
      @keyframes fadein {
        from {opacity:0; transform:translateX(50%);}
        to {opacity:1; transform:translateX(0);}
      }
      @keyframes fadeout {
        from {opacity:1; transform:translateX(0);}
        to {opacity:0; transform:translateX(50%);}
      }

      #suggester {
        display:flex;
       /* flex-direction:column; */
        justify-content: space-between;
      }
      .button_status:hover {
        background:grey;
      }
    </style>
    <script>
      function showToast(message, color = '#4CAF50') {
        const toast = document.createElement('div');
        toast.classList.add('toast');
        toast.textContent = message;
        toast.style.backgroundColor = color;
        document.getElementById('toast-container').append(toast);
        setTimeout(() => {
          toast.remove();
        }, 15000)
      }

      async function popAdresse (adresse) {
      //  document.getElementById('lightPB2').textContent = "Chargement de l'adresse...";
     //   const adresse = await fetch(`https://fleuread.onrender.com/osm?coords=${longitude},${latitude}`);
        document.getElementById('lightPB2').textContent = adresse;
      }
    </script>
    <script>
            async function putComptes(filtre) {
              await setForComptes ();
              document.getElementById("registerPop").onclick = () => logModificationB();
        console.log("Appel d'un putComptes...");
        const bennes = await getComptes();
        console.log(bennes);
        let filtered = [];
        if (filtre !== 'no') {
        filtered = await filter(bennes, filtre);
        } else {
        filtered = bennes;
        }
        console.log("Le système a filtré la liste :");
        console.log(filtered);
        const bennesContainer = document.getElementById('comptesContent');
        bennesContainer.innerHTML = "";
        console.log("On va traiter l'ajout...");
        for (const ben of filtered) {
          console.log("Création d'une compte :", ben);
          const line = document.createElement('div');
          line.classList.add('line');
          line.id = `C${ben.id}`;
comDatas[ben.id] = ben;
       const lightbox = document.getElementById('lightboxB');
       const closeBtn = document.getElementById('close-btnB');
        const imagePop = document.getElementById('lightImgB');
      console.log("LIGHTBOX");
      line.addEventListener('click', () => {
         lightbox.style.display = 'flex';
        console.log("Lien image :", ben.link);
        document.getElementById('imagePop').src = ben.link;
         document.getElementById('lightH2B').innerHTML = ben.first_name + " " + ben.name + " <br> " + toreadOpt(ben.auth);
         document.getElementById('lightPB').textContent =  "Compte n°" + ben.id; // 
        document.getElementById('lightPB2').textContent =  "Euréa Coop";
        document.getElementById('lightPB3').innerHTML =  "Dernière connexion : <strong>" + formatTimestamp(ben.last_connection) + "</strong>" ;
  
        numon = ben.id;
        console.log(numon);
        document.getElementById('editeurLightBenne').style.display == 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
        closeBtn.addEventListener('click', () => {
         lightbox.style.display = 'none';
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
       lightbox.addEventListener('click', (e) => {
         if (e.target === lightbox) {
           lightbox.style.display = 'none';
             document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
         }
       });
    
          
         // const num = document.createElement('p');
         // num.textContent = ben.id;
        //  line.append(num);
          const status = document.createElement('p');
          status.innerHTML = ben.first_name + " " + ben.name + " <br> " + toreadOpt(ben.auth);
          line.append(status);
          const notes = document.createElement('p');
          notes.textContent = ben.password;
          line.append(notes);
          const pds = document.createElement('p');
          pds.textContent = formatTimestamp(ben.last_connection);;
          line.append(pds);
          bennesContainer.append(line);
        }
      }
      async function getComptes() {
        return await fetcher('getcomptes',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
      }

         document.getElementById('createCompte').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = await Object.fromEntries(formData.entries());
        const content = {
          name:data.name,
          first_name:data.first_name
        };
        const fromServer = await fetcher('createcompte', content, 'POST', sessionStorage.getItem('session_id'));
        showToast(`Création du compte de ${data.NOM} !`);
        putComptes('no');
        document.getElementById('createCompte').reset();
      });

      async function deleteCompte(num) {
        console.log(numon)
        if (confirm(`Supprimer le compte n°${numon} ?`)) {
          if(confirm("Confirmez pour la dernière fois... Cette action est irréversible")) {
        const content = {
          num:num
        };
        const fromServer = await fetcher('deletecompte', content, 'POST', sessionStorage.getItem('session_id'));
            showToast(`Suppression effective (Compte n°${numon}) !`);
        putComptes('no');
          }}
      }

        async function putClients(filtre) {
              await setForClients ();
              document.getElementById("registerPop").onclick = () => logModificationC();
        console.log("Appel d'un putClients...");
        const bennes = await getClients();
        console.log(bennes);
        let filtered = [];
        if (filtre !== 'no') {
        filtered = await filter(bennes, filtre);
        } else {
        filtered = bennes;
        }
        console.log("Le système a filtré la liste :");
        console.log(filtered);
        const bennesContainer = document.getElementById('clientsContent');
        bennesContainer.innerHTML = "";
        console.log("On va traiter l'ajout...");
        for (const ben of filtered) {
          console.log("Création d'un client :", ben);
          const line = document.createElement('div');
          line.classList.add('line');
          line.id = `D${ben.id}`;
cliDatas[ben.id] = ben;
       const lightbox = document.getElementById('lightboxB');
       const closeBtn = document.getElementById('close-btnB');
        const imagePop = document.getElementById('lightImgB');
      console.log("LIGHTBOX");
      line.addEventListener('click', () => {
         lightbox.style.display = 'flex';
        console.log("Lien image :", ben.link);
        document.getElementById('imagePop').src = ben.link;
         document.getElementById('lightH2B').textContent =  ben.name;
         document.getElementById('lightPB').textContent = "Client n°" + ben.id; // 
        // document.getElementById('lightPB2').textContent =  "Euréa Coop";
        document.getElementById('lightPB3').innerHTML =  "Contact : <strong>" + ben.phonenumber + "</strong>" ;
        popAdresse(ben.adresse);
        numon = ben.id;
        console.log(numon);
        document.getElementById('editeurLightBenne').style.display == 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
        closeBtn.addEventListener('click', () => {
         lightbox.style.display = 'none';
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
       lightbox.addEventListener('click', (e) => {
         if (e.target === lightbox) {
           lightbox.style.display = 'none';
             document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
         }
       });
    
          
        const num = document.createElement('p');
        num.textContent = ben.id;
        line.append(num);
          const status = document.createElement('p');
          status.innerHTML = ben.name + " <br> " + ben.phonenumber;
          line.append(status);
          const notes = document.createElement('p');
          notes.textContent = ben.notes;
          line.append(notes);
          const pds = document.createElement('p');
          pds.textContent = ben.adresse;
          line.append(pds);
          bennesContainer.append(line);
        }
      }
      async function getClients() {
        return await fetcher('getclients',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
      }

         document.getElementById('createClient').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = await Object.fromEntries(formData.entries());
        const content = {
          phonenumber:data.phonenumber,
          name:data.name
        };
        const fromServer = await fetcher('createclient', content, 'POST', sessionStorage.getItem('session_id'));
        showToast(`Création du client ${data.name} !`);
        putClients('no');
        document.getElementById('createClient').reset();
      });

      async function deleteClient(num) {
        console.log(numon)
        if (confirm(`Supprimer le client n°${numon} ?`)) {
          if(confirm("Confirmez pour la dernière fois... Cette action est irréversible")) {
        const content = {
          num:num
        };
        const fromServer = await fetcher('deleteclient', content, 'POST', sessionStorage.getItem('session_id'));
            showToast(`Suppression effective (Client n°${numon}) !`);
        putClients('no');
          }}
      }
      
      function formatTimestamp(timestamp) {
  const date = new Date(timestamp);

  const jour = String(date.getDate()).padStart(2, '0');
  const mois = String(date.getMonth() + 1).padStart(2, '0'); // +1 car les mois commencent à 0
  const annee = String(date.getFullYear()).slice(-2); // Prend les 2 derniers chiffres

  const heures = String(date.getHours() + offset).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');

  return `${jour}/${mois}/${annee} à ${heures}h${minutes}`;
}

      async function putCereales(filtre) {
              await setForCereales ();
              document.getElementById("registerPop").onclick = () => logModificationD();
        console.log("Appel d'un putCereales...");
        const bennes = await getCereales();
        console.log(bennes);
        let filtered = [];
        if (filtre !== 'no') {
        filtered = await filter(bennes, filtre);
        } else {
        filtered = bennes;
        }
        console.log("Le système a filtré la liste :");
        console.log(filtered);
        const bennesContainer = document.getElementById('cerealesContent');
        bennesContainer.innerHTML = "";
        console.log("On va traiter l'ajout...");
        for (const ben of filtered) {
          console.log("Création d'un client :", ben);
          const line = document.createElement('div');
          line.classList.add('line');
          line.id = `E${ben.id}`;
cerDatas[ben.id] = ben;
       const lightbox = document.getElementById('lightboxB');
       const closeBtn = document.getElementById('close-btnB');
        const imagePop = document.getElementById('lightImgB');
      console.log("LIGHTBOX");
      line.addEventListener('click', () => {
         lightbox.style.display = 'flex';
        console.log("Lien image :", ben.photo);
        document.getElementById('imagePop').src = ben.photo;
         document.getElementById('lightH2B').textContent =  ben.name;
         document.getElementById('lightPB').textContent = "Code : " + ben.code; // 
        document.getElementById('lightPB2').textContent =  "Euréa Coop";
        document.getElementById('lightPB3').innerHTML =  "Céréale" ;
        numon = ben.id;
        console.log(numon);
        document.getElementById('editeurLightBenne').style.display == 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
        closeBtn.addEventListener('click', () => {
         lightbox.style.display = 'none';
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
       lightbox.addEventListener('click', (e) => {
         if (e.target === lightbox) {
           lightbox.style.display = 'none';
             document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
         }
       });
    
          
        //  const num = document.createElement('p');
        //  num.textContent = ben.id;
         // line.append(num);
          const status = document.createElement('p');
          status.textContent = ben.name;
          line.append(status);
          const notes = document.createElement('p');
          notes.textContent = ben.code;
          line.append(notes);
         const pds = document.createElement('p');
        pds.textContent = ben.adresse;
         line.append(pds);
          bennesContainer.append(line);
        }
      }
      async function getCereales() {
        return await fetcher('getcereales',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
      }

         document.getElementById('createCereale').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = await Object.fromEntries(formData.entries());
        const content = {
          name:data.name
        };
        const fromServer = await fetcher('createcereale', content, 'POST', sessionStorage.getItem('session_id'));
        showToast(`Création de la céréale ${data.name} !`);
        putCereales('no');
        document.getElementById('createCereale').reset();
      });

      async function deleteCereale(num) {
        console.log(numon)
        if (confirm(`Supprimer la céréale n°${numon} ?`)) {
          if(confirm("Confirmez pour la dernière fois... Cette action est irréversible")) {
        const content = {
          num:num
        };
        const fromServer = await fetcher('deletecereale', content, 'POST', sessionStorage.getItem('session_id'));
            showToast(`Suppression effective (Céréale n°${numon}) !`);
        putCereales('no');
          }}
      }

       async function putParams(filtre) {
              await setForParams ();
              document.getElementById("registerPop").onclick = () => logModificationE();
        console.log("Appel d'un putParams...");
        const bennes = await getParams();
        console.log(bennes);
        let filtered = [];
        if (filtre !== 'no') {
        filtered = await filter(bennes, filtre);
        } else {
        filtered = bennes;
        }
        console.log("Le système a filtré la liste :");
        console.log(filtered);
        const bennesContainer = document.getElementById('infosContent');
        bennesContainer.innerHTML = "";
        console.log("On va traiter l'ajout...");
        for (const ben of filtered) {
          console.log("Création d'un paramètre :", ben);
          const line = document.createElement('div');
          line.classList.add('line');
          line.id = `F${ben.id}`;
paramDatas[ben.id] = ben;
       const lightbox = document.getElementById('lightboxB');
       const closeBtn = document.getElementById('close-btnB');
        const imagePop = document.getElementById('lightImgB');
      console.log("LIGHTBOX");
      line.addEventListener('click', () => {
         lightbox.style.display = 'flex';
        console.log("Lien image :", ben.photo);
        document.getElementById('imagePop').src = ben.photo;
         document.getElementById('lightH2B').textContent =  ben.donnee;
         document.getElementById('lightPB').textContent = ben.value; // 
        document.getElementById('lightPB2').textContent =  "Euréa Coop";
        document.getElementById('lightPB3').innerHTML =  "Paramètre" ;
        numon = ben.id;
        console.log(numon);
        document.getElementById('editeurLightBenne').style.display == 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
        closeBtn.addEventListener('click', () => {
         lightbox.style.display = 'none';
        document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
       });
       lightbox.addEventListener('click', (e) => {
         if (e.target === lightbox) {
           lightbox.style.display = 'none';
             document.getElementById('editeurLightBenne').style.display = 'none';
        selecter.selectedIndex = 0;
         document.getElementById('inpSelecter').value = "";
         }
       });
    
          
        //  const num = document.createElement('p');
         // num.textContent = ben.id;
        //  line.append(num);
          const status = document.createElement('p');
          status.textContent = ben.donnee;
          line.append(status);
          const notes = document.createElement('p');
          notes.textContent = ben.value;
          line.append(notes);
         // const pds = document.createElement('p');
         // pds.textContent = ben.adresse;
         // line.append(pds);
          bennesContainer.append(line);
        }
      }
      async function getParams() {
        return await fetcher('getparams',{'id':sessionStorage.getItem('session_id')},'POST',sessionStorage.getItem('session_id'));
      }
    </script>
    <script>
      const input =  document.getElementById('mapSearch_input');
      const resultContainer = document.getElementById('result_mapSearch');
      let thisvalue;
      let debounceTimer;
      
      input.addEventListener('input', async () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
        thisvalue = input.value;
        const answer = await fetcher('smartsearchmap',{value:thisvalue}, 'POST', sessionStorage.getItem('session_id'));
        resultContainer.innerHTML = "";
        if (answer.length > 1) {
        for (const item of answer) {
          const button = document.createElement('div');
          button.style.backgroundColor = "rgba(173, 216, 230, 0.5)";
          button.style.border = "1px solid black";
          button.style.width = "100 %";
          button.innerHTML = `${item.text}`;
          button.onclick = () => {
            input.value = item.text;
            input.dispatchEvent(new Event('input', { bubbles: true }));
            focusOn(item.text,item.position);
            setTimeout(() => {resultContainer.innerHTML = "";}, 2000);
          }
          resultContainer.append(button);
        }
        } else if (answer.length < 1) {
          const button = document.createElement('button');
          button.innerHTML = `Aucun élément ne correspond à votre recherche.`;
          resultContainer.append(button);
        } else {
          focusOn(answer[0].text,answer[0].position);
        }
        }, 500);
      });
    </script>
    <script>
      async function pushPanel(id) {
        onshow = true;
        nowPanel = id;
        const panel = document.getElementById('panelcontent');
        document.getElementById('panel').style.display = "flex";
        document.getElementById('mapSearch').style.display = "none";
        const content = {
          id:id,
            offset:offset
        };
        let fromServer = await fetcher ('getbenneinformations', content, 'POST', sessionStorage.getItem('session_id'));
        fromServer = fromServer.message;
        console.log(fromServer);
        document.getElementById('panel_A_img').src = fromServer.n;
        document.getElementById('panel_A_h1').textContent = fromServer.a;
        document.getElementById('panel_B_p').textContent = toread(fromServer.b);
        document.getElementById('panel_B').style.backgroundColor = tocolor(fromServer.b);
        document.getElementById('panel_C_p').textContent = fromServer.c;
        document.getElementById('panel_C_i').textContent = fromServer.d;
         document.getElementById('panel_V_p').textContent = fromServer.g;
        document.getElementById('panel_V_pb').textContent = fromServer.h;

document.getElementById('editer_a').textContent = toread("A");
document.getElementById('editer_a').style.backgroundColor = tocolor("A");
document.getElementById('editer_b').textContent = toread("B");
document.getElementById('editer_b').style.backgroundColor = tocolor("B");
document.getElementById('editer_c').textContent = toread("C");
document.getElementById('editer_c').style.backgroundColor = tocolor("C");

document.getElementById('editer_a').onclick = async () => {
        const content = {
          toupd : 'statut',
          value_toupd : 'A',
          eq:'num',
          value_eq:fromServer.a
        };
        console.log(content);
        const responseServer = await fetcher('editbenne', content, 'POST', sessionStorage.getItem('session_id'));
          pushPanel(fromServer.a);
}

        document.getElementById('editer_b').onclick = async () => {
        const content = {
          toupd : 'statut',
          value_toupd : 'B',
          eq:'num',
          value_eq:fromServer.a
        };
        console.log(content);
        const responseServer = await fetcher('editbenne', content, 'POST', sessionStorage.getItem('session_id'));
          pushPanel(fromServer.a);
}

        document.getElementById('editer_c').onclick = async () => {
        const content = {
          toupd : 'statut',
          value_toupd : 'C',
          eq:'num',
          value_eq:fromServer.a
        };
        console.log(content);
        const responseServer = await fetcher('editbenne', content, 'POST', sessionStorage.getItem('session_id'));
          pushPanel(fromServer.a);
}
        document.getElementById('panel_I_lat').textContent = fromServer.o;
        document.getElementById('panel_I_lon').textContent = fromServer.p;
        document.getElementById('panel_I_alt').textContent = `${Math.round(parseFloat(fromServer.q))} m`;
         document.getElementById('panel_D_i').textContent = fromServer.e;
        document.getElementById('panel_D_i').href = `https://www.google.com/maps?q=${fromServer.o},${fromServer.p}`;
         document.getElementById('panel_E_img').src = fromServer.l;
        document.getElementById('panel_E_h1').textContent = fromServer.f;
        document.getElementById('panel_F_img').src = fromServer.k;
        document.getElementById('panel_F_p').textContent = "Posée par " + fromServer.i;
        document.getElementById('panel_F_pb').textContent = fromServer.j;
        document.getElementById('panel_G_button').onclick = () => {
          window.open(`https://fleuread.onrender.com/historique?type=benne&id=${fromServer.a}`, '_blank');
          }
        }

    </script>
       <script>
         let nowPanel;
      const inputB =  document.getElementById('cereale_input_search');
      // const resultContainer = document.getElementById('result_mapSearch');
      let thisvalueB;
      let debounceTimerB;
      
      inputB.addEventListener('input', async () => {
        clearTimeout(debounceTimerB);
        debounceTimerB = setTimeout(async () => {
        thisvalueB = inputB.value;
        const answer = await fetcher('smartsearchcereale',{value:thisvalueB, biobool:document.getElementById('bioounon').checked}, 'POST', sessionStorage.getItem('session_id'));
          
        if (answer.length < 1) {
         showToast("Aucune correspondance, consultez l'interface d'administration",'red');
        } else if (answer.length == 1) {
                 const content = {
                toupd : 'céréale',
                value_toupd : answer[0].search,
                eq:'num',
                value_eq:nowPanel
              };
              console.log(content);
              const responseServer = await fetcher('editbenne', content, 'POST', sessionStorage.getItem('session_id'));
                pushPanel(nowPanel);
          showToast("Modification enregistrée !",'blue');
          inputB.value = "";
        }
        }, 500);
      });
    </script>
    <script>
         // let nowPanel;
      const inputA =  document.getElementById('farm_input_search');
      // const resultContainer = document.getElementById('result_mapSearch');
      let thisvalueA;
      let debounceTimerA;
      
      inputA.addEventListener('input', async () => {
        clearTimeout(debounceTimerA);
        debounceTimerA = setTimeout(async () => {
        thisvalueA = inputA.value;
        const answer = await fetcher('smartsearchfarm',{value:thisvalueA}, 'POST', sessionStorage.getItem('session_id'));
          
        if (answer.length < 1) {
         showToast("Aucune correspondance, consultez l'interface d'administration",'red');
        } else if (answer.length == 1) {
                 const content = {
                toupd : 'id_client',
                value_toupd : answer[0].search,
                eq:'num',
                value_eq:nowPanel
              };
              console.log(content);
              const responseServer = await fetcher('editbenne', content, 'POST', sessionStorage.getItem('session_id'));
                pushPanel(nowPanel);
          showToast("Modification enregistrée !",'blue');
          inputA.value = "";
        }
        }, 500);
      });

      async function disconnect () {
        console.log("DISCONNECTION");
        sessionStorage.removeItem('session_id');
        localStorage.removeItem('offtoken');
        
        start();
      
      }
    </script>
    <script>
      let onshow = false;
      let changerState = false;
      document.getElementById('move_benne').addEventListener('click', function () {
        changerState = true;
        console.log(changerState);
        showToast("Cliquez sur la carte pour placer la benne dans moins de 15 secondes.", 'blue');
        setTimeout(() => {
          changerState = false;
        }, 15000);
      })

      async function reloadBenne () {
        document.getElementById('filtrerBennes').click();
        plotPoints();
        if (onshow) {
        pushPanel(nowPanel);
        }
      }

      document.getElementById('bioounon').addEventListener('change', async function () {
        const value = document.getElementById('bioounon').checked;
        console.log(value);
        if (value) {
          document.getElementById('bio_temoin').textContent = "Oui";
        } else {
          document.getElementById('bio_temoin').textContent = "Non";
        }
      });
    </script>
    <script>
      async function showAdmin () {
        // nowPanel
        document.getElementById('adminBtn').click();
        document.getElementById('btnBennes').click();
        document.getElementById('text_searcherBenne').value = `B${nowPanel}A${nowPanel}`;
        document.getElementById('filtrerBennes').click();
      }
      async function showMap (id) {
        // nowPanel
        document.getElementById('close-btnB').click(); // Fermer Pop-up
        console.log("Step 1");
        document.getElementById('visuBtn').click(); // Afficher la carte
        console.log("Step 2");
        setTimeout(() => {
        document.getElementById('mapSearch_input').value = `FOCUS:${id}`;
          document.getElementById('mapSearch_input').dispatchEvent(new Event('input', { bubbles: true }));
          console.log("Step 3");
        pushPanel(id);
          console.log("Step 4");
        }, 1000);
      }
    </script>
  </body>
</html>
