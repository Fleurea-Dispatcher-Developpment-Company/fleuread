<!DOCTYPE html>
<html>
  <head>
    <title>Fleuréa Dispatcher | Historique</title>
    <link rel="shortcut icon" href="https://res.cloudinary.com/devee5rfe/image/upload/v1754320567/OIP_lz4npc.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    
  </head>
  <body>
     <div id="toast-container"></div>
  
    <div style="border:2px outset black; overflow-y:auto; position:absolute; top:1vh; left:1vw; height:95vh; width:98vw;">
     <table class="w3-center" style="width:100%; border:2px solid black; border-collapse:collapse; text-align:center;vertical-align:center;" id="tablehisto"></table>
      <p class="w3-center" id="result">Chargement des données en cours...</p>
    </div>
    
    <div style="display:flex, fex-direction:column; position:absolute; top:97vh; left:1vw; height:1vh; width:98vw;">
     <button>Format PDF</button>
      <button>Format Excel</button>
      <button>Format Texte</button>
    </div>
       <script>
      const offset = -((new Date().getTimezoneOffset()) / 60);
      console.log(offset);
      
          async function start() {
      url = new URL(window.location.href);
      sessionId = await sessionStorage.getItem('session_id');
      if (!sessionId) {
        console.log("Not connected");
        window.location.href = `https://${url.hostname}`; 
      } else {
        if (await check(sessionId)) {
        console.log("Connected");
        } else {
        sessionStorage.removeItem('session_id');
        console.log("Not connected");
        window.location.href = `https://${url.hostname}`; 
        }
      }
            readParams();
      }
      async function check(id) {
        const answer = await fetcher('checksession',{'id':id},'POST','noauth');
        const bool = answer.value;
        console.warn(bool);
        if (bool) {
          console.warn("true");
          return true;
        } else {
          console.warn("false");
          return false;
        }
      }
      
      start();
      async function fetcher (endpoint, body, method, auth) {
        try {
        const response = await fetch(`https://${url.host}/${endpoint}`,{
          'method':method,
          'headers' : {
            'Content-Type':'application/json',
            'auth': auth
          }, 
          'body' : JSON.stringify(body)
        });
        const data = await response.json();
          return data;
        } catch (err) {return err;}
      }

      function showToast(message, color = '#4CAF50') {
        const toast = document.createElement('div');
        toast.classList.add('toast');
        toast.textContent = message;
        toast.style.backgroundColor = color;
        document.getElementById('toast-container').append(toast);
        setTimeout(() => {
          toast.remove();
        }, 15000)
      }
let alltype;
let allid;
          async function readParams () {
        // showToast("Lecture des paramètres en cours...");
       
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        alltype = urlParams.get('type');
        const id = urlParams.get('id');
        allid = urlParams.get('id');
       //   showToast(`Résult : ${id} / ${action}`);
        getHistorique(type, id);
      }
 let debounceTimer;
const tabler = document.getElementById("tablehisto");
tabler.innerHTML = "<thead><tr><th>Date / Heure</th><th>Actionneur</th><th>Action</th><th>Élément</th><th>Type</th><th>Caractère</th><th>Affectation</th></tr><tr><th style='display:flex; flex-direction:column;'><input type='datetime-local' id='dateinput' placeholder='DÉBUT'><input type='datetime-local' id='timeinput' placeholder='FIN'></th><th><input type='text' id='whoinput' placeholder='ACTIONNEUR'></th><th><input min='0' max='3' step='1' type='number' id='contentinput' placeholder='ACTION'></th><th><input type='text' id='iteminput' placeholder='ÉLÉMENT'></th><th><input type='text' id='typeinput' placeholder='TYPE'></th><th><input type='text' id='carainput' placeholder='CARACTÈRE'></th><th><input type='text' id='affecinput' placeholder='AFFECTATION'></th></tr></thead>";
      const tbody = document.createElement('tbody');
      tabler.append(tbody);
      
      async function setConstants () {
      tbody.innerHTML = "";
      const aplug = document.getElementById('dateinput');
      const bplug = document.getElementById('timeinput');
      const cplug = document.getElementById('whoinput');
      const dplug = document.getElementById('contentinput');
      aplug.addEventListener('input', resetTable);
      bplug.addEventListener('input', resetTable);
      cplug.addEventListener('input', resetTable);
      dplug.addEventListener('input', resetTable);

        const eplug = document.getElementById('iteminput');
      const fplug = document.getElementById('typeinput');
      const gplug = document.getElementById('carainput');
      const hplug = document.getElementById('affecinput');
      eplug.addEventListener('input', resetTable);
      fplug.addEventListener('input', resetTable);
      gplug.addEventListener('input', resetTable);
      hplug.addEventListener('input', resetTable);
     
      async function resetTable () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
        console.log(aplug.value);
        console.log(bplug.value);
          // date.setHours(date.getHours() - offset);
        const query = {
          a:aplug.value,
          b:bplug.value,
          c:cplug.value,
          d:dplug.value,
          e:eplug.value,
          f:fplug.value,
          g:gplug.value,
          h:hplug.value,
          offset:offset
        };
        getHistorique(alltype, allid, query);
        }, 1000);
      }
      }
      
      async function getHistorique(type, id, query) {
        
        const datas = await fetcher('gethistorique', {id:id, type:type, query:query}, 'POST', sessionStorage.getItem('session_id'));
        setConstants();
         document.getElementById('result').textContent = "";
        if (datas.length == 0) {
          document.getElementById('result').textContent = "Aucun élément ne correspond à votre recherche...";
        }
        
        for (const item of datas) {
          // const line = document.createElement('div');
         // line.style.width = '100%';
         // line.style.backgroundColor = 'white';
         // line.style.border = '1px solid black';
         // line.style.marginBottom = "1vh";
         // const a = document.createElement('p');
         // a.textContent = `${formatTimestamp(item.when)} - ${item.who} a ${await convertToWords(item.content)} l'élément n°${item.what} des ${item.table} (${item.type} → ${item.value})`;
         // a.classList.add('w3-center');
         // line.append(a);
        //  document.getElementById('histocontainer').append(line);

          
          const tr = document.createElement('tr');
          tbody.append(tr);
          const td1 = document.createElement('td');
          tr.append(td1);
          td1.textContent = formatTimestamp(item.when);
          const td2 = document.createElement('td');
          tr.append(td2);
          // const whohere = await fetcher('getidname', {id:item.who}, 'POST', sessionStorage.getItem('session_id'));
          td2.textContent = item.who;

          const td3 = document.createElement('td');
          tr.append(td3);
          td3.textContent = await convertToWords(item.content);
          const td4 = document.createElement('td');
          tr.append(td4);
          td4.textContent = item.what;
          const td5 = document.createElement('td');
          tr.append(td5);
          td5.textContent = formatStringB(item.table);
          const td6 = document.createElement('td');
          tr.append(td6);
          td6.textContent = item.type;
          const td7 = document.createElement('td');
          tr.append(td7);
          if (item.content == "2") {
          td7.innerHTML = `<a href="https://www.google.com/maps?q=${item.value}">${item.value}</a>`; 
          } else {
          td7.textContent = item.value;
          }
        }
      }

      async function convertToWords (input) {
        if (input == "1") {
          return "Modification";
        }
        if (input == "2") {
          return "Déplacement";
        }
        if (input == "3") {
          return "Création";
        }
      }

      function formatTimestamp(timestamp) {
  console.warn("Entrée :", timestamp);
  console.warn("Offset :", offset);
  const date = new Date(timestamp);
  console.log(date);
 // date.setHours(date.getHours() + offset);
  const jour = String(date.getDate()).padStart(2, '0');
  const mois = String(date.getMonth() + 1).padStart(2, '0'); // +1 car les mois commencent à 0
  const annee = String(date.getFullYear()).slice(-2); // Prend les 2 derniers chiffres

  const heures = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
console.warn(`${jour}/${mois}/${annee} à ${heures}h${minutes}`);
  return `${jour}/${mois}/${annee} à ${heures}h${minutes}`;
}

      function formatStringB(str) {
  if (!str) return ""; // si chaîne vide
  // Met la première lettre en majuscule
  let formatted = str.charAt(0).toUpperCase() + str.slice(1);
  // Supprime le "s" final si présent
  if (formatted.endsWith("s")) {
    formatted = formatted.slice(0, -1);
  }
  return formatted;
}
    </script>
    <style>
      #tablehisto th, 
#tablehisto td {
  border: 1px solid black;
}

      #tablehisto th {
        align-items:center;
        margin:0 0;
        padding:0 0;
      }
      
      /* tbody {
        overflow-y:auto;
        height:75%;
        display:block;
      } */
      body {
          margin: 0;
          padding:1rem;
          height: 100vh;
          width: 100vw;
          display:flex;
          justify-content:center; /* aligné à l'horizontal */
          align-items:center; /* aligné en vertical */
          background: linear-gradient(135deg, blue, red);
          font-family: Arial, sans-serif;
           box-sizing:border-box; 
      }
      .form-container {
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          width:100%;
          height:auto;
          max-width:400px;
          box-shadow: 0 8px 20px rgba(0,0,0,0.7);
         box-sizing:border-box;
      }
      #pdfbutton {
        position:absolute;
        z-index:10000;
        top: 50;
        right:2vh;
          opacity:50%;
        color:blue;
        background-color:white;
      }
      #pdfbutton:hover {
        opacity:100%;
      }
      input {
        width: 100%;
        height:2vh;
        padding: 0.75rem;
      /*  margin-bottom: 1rem; */
        border: 1px solid #ccc;
        border-radius: 0.5rem;
        font-size: 1rem;
        box-sizing:border-box; 
      }
      button {
        width: 100%;
        padding: 0.75rem;
        background-color:blue;
        color:white;
        margin-bottom: 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor:pointer;
        transition:background 0.3s ease;
       box-sizing:border-box;
      }
      button:hover {
        background-color:red;
      }
      #histocontainer {width:100%;}
      img {
        max-width:80%;
        height:auto;
       box-sizing:border-box;
        margin:0.5rem;
      }
      #toast-container {
        position:fixed;
        bottom:2vh;
        right:2vw;
        z-index:9999;
        display:flex;
        flex-direction:column;
        gap:1vh;
      }
      .toast {
        background-color:#4CAF50;
        color:white;
        padding: 1rem 1.5rem;
        border-radius:5px;
        font-size:1rem;
        box-shadow: 0 0 10px;
        animation:fadein 0.5s, fadeout 0.5s 14.5s;
        opacity:0;
        animation-fill-mode:forwards;
      }
      @keyframes fadein {
        from {opacity:0; transform:translateX(50%);}
        to {opacity:1; transform:translateX(0);}
      }
      @keyframes fadeout {
        from {opacity:1; transform:translateX(0);}
        to {opacity:0; transform:translateX(50%);}
      }
    </style>
    <script>
      // Génération des documents
       function createPDF() {
        const now = new Date();
        const nowFormatted = String(now.getDate()) + String(now.getMonth()) + String(now.getFullYear()) + String(now.getHours()) + String(now.getMinutes()) + String(now.getSeconds());
          console.log(nowFormatted);
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
      
          doc.autoTable({
            html: '#tableau',
            theme: 'grid',
            headStyles: { fillColor: [80, 80, 80], 
                         halign:'center',
                         valign:'middle'
                        },
            bodyStyles: {
                          halign:'center',
                         valign:'middle'
            }
          });
      
          doc.save(`calculautomatiquedesdistances${nowFormatted}.pdf`);
    }
    
    function createExcel() {
  const wb = XLSX.utils.book_new(); // Crée un nouveau classeur
  const table = document.getElementById("tableau"); // Récupère le tableau HTML

  // Convertit le tableau HTML en feuille de calcul
  const ws = XLSX.utils.table_to_sheet(table);

  // Ajoute la feuille au classeur
  XLSX.utils.book_append_sheet(wb, ws, "Distances");

  // Format de nom avec timestamp
  const now = new Date();
  const nowFormatted = String(now.getDate()).padStart(2, "0") +
                       String(now.getMonth() + 1).padStart(2, "0") +
                       String(now.getFullYear()) +
                       "_" +
                       String(now.getHours()).padStart(2, "0") +
                       String(now.getMinutes()).padStart(2, "0") +
                       String(now.getSeconds()).padStart(2, "0");

  // Télécharge le fichier .xlsx
  XLSX.writeFile(wb, `comparateur_distances_${nowFormatted}.xlsx`);
}

    </script>
  </body>
</html>
